{% extends 'panel/base_page/base_admin.html' %}

{% block title %}Nearby Police Stations & Hospitals{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold text-center mb-6">Nearby Police Stations & Hospitals</h1>
    
    <div class="relative">
        <!-- Map Div -->
        <div id="map" class="w-full h-64 rounded-lg shadow-md"></div>
        <div class="loader" id="loader"></div>
    </div>
    
    <div class="text-center">
        <!-- Locate Button -->
        <button id="locate-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">
            Locate Me
        </button>
    </div>

    <div class="bg-gray-100 p-4 rounded-lg shadow-md mt-4">
        <h5 class="font-semibold text-lg">Information</h5>
        <p class="text-gray-700">Click the "Locate Me" button to find your current location. You can choose to show the nearest police station or hospital and view the fastest route to the selected location.</p>
    </div>

    <div class="mt-3">
        <label for="location-type" class="block text-sm font-medium text-gray-700">Choose location type:</label>
        <!-- Location Type Dropdown -->
        <select id="location-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            <option value="police">Police Stations</option>
            <option value="hospital">Hospitals</option>
        </select>
    </div>
</div>

<!-- Google Maps API Script -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&libraries=places&callback=initMap" async defer></script>

<script>
    let map;
    let service;
    let infoWindow;
    let currentLocation;

    // Initialize map
    function initMap() {
        // Initial dummy location (this will be updated by geolocation)
        const dummyLocation = { lat: -34.397, lng: 150.644 };
        map = new google.maps.Map(document.getElementById('map'), {
            center: dummyLocation,
            zoom: 14,
        });

        infoWindow = new google.maps.InfoWindow();
    }

    // Function to handle results from nearby search
    function handleResults(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            results.forEach(place => {
                const marker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                });

                google.maps.event.addListener(marker, 'click', function () {
                    infoWindow.setContent(`<strong>${place.name}</strong><br>${place.vicinity}`);
                    infoWindow.open(map, this);
                });
            });
        } else {
            alert('No places found nearby.');
        }
    }

    // Perform nearby search based on location type
    function performSearch(locationType, lat, lng) {
        const location = new google.maps.LatLng(lat, lng);

        const request = {
            location: location,
            radius: '5000', // Search within 5km radius
            type: [locationType],
        };

        service = new google.maps.places.PlacesService(map);
        service.nearbySearch(request, handleResults);
    }

    // Locate user's position and update the map
    document.getElementById('locate-btn').addEventListener('click', function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentLocation = { lat, lng };

                // Update map to current location
                map.setCenter(currentLocation);

                // Perform search based on the selected type (police or hospital)
                const locationType = document.getElementById('location-type').value;
                performSearch(locationType, lat, lng);
            }, () => {
                alert('Geolocation failed. Please try again.');
            });
        } else {
            alert('Your browser does not support geolocation.');
        }
    });

    // Re-fetch nearby places when location type changes
    document.getElementById('location-type').addEventListener('change', function () {
        if (currentLocation) {
            const locationType = document.getElementById('location-type').value;
            performSearch(locationType, currentLocation.lat, currentLocation.lng);
        } else {
            alert('Please click "Locate Me" first to find your location.');
        }
    });

</script>
{% endblock %}
