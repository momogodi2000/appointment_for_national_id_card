{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/map2.css' %}">
    
    <style>
        /* General styles */
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        .map-container { height: 400px; position: relative; margin-top: 20px; }
        #map { width: 100%; height: 100%; border-radius: 4px; }
        .loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .info-box { background: #ffffff; padding: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<div class="dashboard">
    <div class="dashboard-nav">
        <header>
            <a href="{% url 'admin_panel' %}" class="brand-logo animate__animated animate__fadeInLeft">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}'s profile picture" class="profile-pic" />
                {% else %}
                    <img src="{% static 'img/yvan.jpg' %}" alt="Default Avatar" class="profile-pic" />
                {% endif %}
                <span>{{ user.username }}'s Panel</span>
            </a>
        </header>
        <nav class="dashboard-nav-list">
            <a href="{% url 'admin_panel' %}" class="dashboard-nav-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="{% url 'manage_users' %}" class="dashboard-nav-item"><i class="fas fa-users-cog"></i> Manage Users</a>
            <a href="{% url 'manage_documents' %}" class="dashboard-nav-item"><i class="fas fa-file-upload"></i> Manage Documents</a>
            <a href="{% url 'contact_messages' %}" class="dashboard-nav-item"><i class="fas fa-envelope"></i> Manage Contact</a>
            <a href="{% url 'analyse' %}" class="dashboard-nav-item"><i class="fas fa-chart-pie"></i> Analyze</a>
            <a href="{% url 'admin_communications' %}" class="dashboard-nav-item"><i class="fas fa-comments"></i> Communications</a>
            <a href="{% url 'map' %}" class="dashboard-nav-item"><i class="fas fa-map-marker-alt"></i> Map</a>
            <a href="{% url 'about_us' %}" class="dashboard-nav-item"><i class="fas fa-info-circle"></i> About Us</a>
            <a href="{% url 'security_settings' %}" class="dashboard-nav-item"><i class="fas fa-cogs"></i> General Settings</a>
            <a href="{% url 'logout' %}" class="dashboard-nav-item"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>
    <main class="dashboard-app">
        <header class="dashboard-toolbar">
            <a href="#!" class="menu-toggle"><i class="fas fa-bars"></i></a>
            <div class="header-icons">
                <i class="fas fa-globe icon" title="Change Language" onclick="toggleLanguage()"></i>
                <i class="fas fa-paint-brush icon" title="Change Theme" onclick="toggleTheme()"></i>
                <div class="search-bar">
                    <input type="text" placeholder="Search..." aria-label="Search" />
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </header>
<body>


        {% block content %}{% endblock %}
 <!-- OpenStreetMap (Leaflet) -->
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

 <script>
     document.addEventListener("DOMContentLoaded", function() {
         const map = L.map('map').setView([0, 0], 13);

         // Load OpenStreetMap tiles
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             maxZoom: 19,
             attribution: 'Â© OpenStreetMap contributors'
         }).addTo(map);

         // Locate button functionality
         document.getElementById('locate-btn').onclick = function () {
             if (navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(function (position) {
                     const lat = position.coords.latitude;
                     const lng = position.coords.longitude;
                     const locationType = document.getElementById("location-type").value;

                     // Center map to user location
                     map.setView([lat, lng], 13);

                     // Add marker for user location
                     L.marker([lat, lng]).addTo(map).bindPopup("You are here!").openPopup();

                     // Fetch nearby locations using Geoapify API
                     loadNearbyLocations(lat, lng, locationType);
                 });
             } else {
                 alert("Geolocation is not supported by this browser.");
             }
         };

         // Function to load nearby locations (police or hospitals) using Geoapify API
         function loadNearbyLocations(lat, lng, locationType) {
             const loader = document.getElementById("loader");
             loader.style.display = 'block';

             // Define the API endpoint and API key
             const apiKey = '80190a6071c04a13a2d62ca5716c7c45';
             const locationQuery = locationType === 'police' ? 'police' : 'hospital';

             // Make the request to Geoapify for nearby locations
             fetch(`https://api.geoapify.com/v2/places?categories=${locationQuery}&filter=circle:${lng},${lat},5000&limit=10&apiKey=${apiKey}`)
                 .then(response => response.json())
                 .then(data => {
                     data.features.forEach(feature => {
                         const { lat, lon, name } = feature.properties;

                         // Add a marker for each location
                         L.marker([lat, lon]).addTo(map).bindPopup(`${name}`);
                     });
                 })
                 .catch(error => console.error('Error fetching nearby locations:', error))
                 .finally(() => {
                     loader.style.display = 'none';
                 });
         }
     });
 </script>
</body>
</html>
