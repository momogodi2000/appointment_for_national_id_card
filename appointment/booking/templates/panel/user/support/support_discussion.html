{% extends "base.html" %}
{% load static %}

{% block title %}Support Discussion{% endblock %}

{% block content %}
<!-- Bootstrap CSS -->

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

<!-- Custom CSS -->

<link rel="stylesheet" href="{% static 'css/support_discussion.css' %}">

<!-- Font Awesome -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<div class="container-fluid chat-container">
    <div class="row justify-content-center">
        <div class="col-md-6 chat-box">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> Support Chat</h3>
            </div>
            <div class="chat-body" id="chatBody">
                <!-- Chat messages will appear here -->
                <div class="bot-message">
                    <div class="message-content">
                        <p>Hello! I'm here to assist you with questions about national ID card delivery and Cameroonian administrative matters. How can I help you today?</p>
                    </div>
                </div>
            </div>
            <div class="chat-footer">
                <form id="chatForm">
                    <div class="input-group">
                        <input type="text" id="userInput" class="form-control" placeholder="Type your message here..." autocomplete="off" required>
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="loading-spinner d-none" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- JQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<!-- Custom JS -->
<script>
    $(document).ready(function() {
        $('#chatForm').on('submit', function(e) {
            e.preventDefault();
            const userMessage = $('#userInput').val().trim();
            if (userMessage) {
                appendUserMessage(userMessage);
                $('#userInput').val('');
                fetchBotResponse(userMessage);
            }
        });

        function appendUserMessage(message) {
            $('#chatBody').append(`
                <div class="user-message">
                    <div class="message-content">
                        <p>${message}</p>
                    </div>
                </div>
            `);
            scrollToBottom();
        }

        function appendBotMessage(message) {
            $('#chatBody').append(`
                <div class="bot-message">
                    <div class="message-content">
                        <p>${message}</p>
                    </div>
                </div>
            `);
            scrollToBottom();
        }

        function fetchBotResponse(message) {
            $('#loadingSpinner').removeClass('d-none');
            $.ajax({
                url: "{% url 'get_bot_response' %}",
                method: 'POST',
                data: {
                    'message': message,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    $('#loadingSpinner').addClass('d-none');
                    appendBotMessage(response.reply);
                },
                error: function() {
                    $('#loadingSpinner').addClass('d-none');
                    appendBotMessage("Sorry, I'm having trouble understanding you right now. Please try again later.");
                }
            });
        }

        function scrollToBottom() {
            $('#chatBody').scrollTop($('#chatBody')[0].scrollHeight);
        }
    });
</script>
{% endblock %}